openapi: 3.0.3
info:
  title: ChamadaWeb API
  version: 1.0.0
  description: |
    API para gestão de turmas, aulas e presenças acadêmicas.
    
    **Autenticação:** Bearer JWT (7 dias de validade)
    
    **Roles:** ADMIN, COORDENADOR, PROFESSOR, ALUNO
  contact:
    name: ChamadaWeb Support
    email: support@chamadaweb.com

servers:
  - url: http://localhost:3000/api/v1
    description: Desenvolvimento local
  - url: https://api.chamadaweb.com/api/v1
    description: Produção

tags:
  - name: Health
    description: Endpoints de saúde e prontidão
  - name: Auth
    description: Autenticação e autorização
  - name: Turmas
    description: Gestão de turmas
  - name: Vínculos
    description: Matrícula de alunos e vínculo de professores
  - name: Aulas
    description: Agendamento de aulas
  - name: Presenças
    description: Marcação e consulta de presenças
  - name: Relatórios
    description: Relatórios de presença

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Token JWT obtido no login

  schemas:
    Error:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          example: VALIDATION_ERROR
        message:
          type: string
          example: Dados inválidos

    Usuario:
      type: object
      properties:
        id:
          type: string
          format: uuid
        nome:
          type: string
        email:
          type: string
          format: email
        role:
          type: string
          enum: [ADMIN, COORDENADOR, PROFESSOR, ALUNO]
        ativo:
          type: boolean
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Turma:
      type: object
      properties:
        id:
          type: string
          format: uuid
        nome:
          type: string
        codigo:
          type: string
          nullable: true
        anoLetivo:
          type: integer
        periodo:
          type: string
          nullable: true
        ativo:
          type: boolean
        createdAt:
          type: string
          format: date-time

    Aula:
      type: object
      properties:
        id:
          type: string
          format: uuid
        idTurma:
          type: string
          format: uuid
        titulo:
          type: string
          nullable: true
        conteudo:
          type: string
          nullable: true
        dataAula:
          type: string
          format: date-time
        horaInicio:
          type: string
          format: date-time
          nullable: true
        horaFim:
          type: string
          format: date-time
          nullable: true
        createdAt:
          type: string
          format: date-time

    Presenca:
      type: object
      properties:
        id:
          type: string
          format: uuid
        idAula:
          type: string
          format: uuid
        idAluno:
          type: string
          format: uuid
        status:
          type: string
          enum: [PRESENTE, AUSENTE, ATRASO, JUSTIFICADA]
        observacao:
          type: string
          nullable: true
        marcadoEm:
          type: string
          format: date-time

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check básico
      description: Retorna o status de saúde da API
      responses:
        '200':
          description: API funcionando
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  timestamp:
                    type: string
                    format: date-time

  /ready:
    get:
      tags:
        - Health
      summary: Readiness check
      description: Verifica se a API está pronta (DB conectado)
      responses:
        '200':
          description: API pronta
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ready
                  database:
                    type: string
                    example: connected
                  timestamp:
                    type: string
                    format: date-time
        '503':
          description: Serviço não disponível
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: not_ready
                  database:
                    type: string
                    example: disconnected
                  timestamp:
                    type: string
                    format: date-time

  /auth/register:
    post:
      tags:
        - Auth
      summary: Registrar novo usuário
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - nome
                - email
                - senha
                - role
              properties:
                nome:
                  type: string
                  minLength: 3
                email:
                  type: string
                  format: email
                senha:
                  type: string
                  minLength: 6
                role:
                  type: string
                  enum: [ADMIN, COORDENADOR, PROFESSOR, ALUNO]
      responses:
        '201':
          description: Usuário criado com sucesso
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  nome:
                    type: string
                  email:
                    type: string
                  role:
                    type: string
        '400':
          description: Dados inválidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Email já cadastrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/login:
    post:
      tags:
        - Auth
      summary: Fazer login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - senha
              properties:
                email:
                  type: string
                  format: email
                senha:
                  type: string
      responses:
        '200':
          description: Login realizado com sucesso
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                    description: JWT Bearer token
                  usuario:
                    $ref: '#/components/schemas/Usuario'
        '401':
          description: Credenciais inválidas
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/me:
    get:
      tags:
        - Auth
      summary: Obter dados do usuário autenticado
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Dados do usuário
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Usuario'
        '401':
          description: Token inválido ou ausente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /turmas:
    get:
      tags:
        - Turmas
      summary: Listar turmas
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Lista de turmas
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Turma'
        '401':
          description: Não autenticado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      tags:
        - Turmas
      summary: Criar turma
      description: Apenas ADMIN e COORDENADOR podem criar turmas
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - nome
                - anoLetivo
              properties:
                nome:
                  type: string
                  minLength: 3
                codigo:
                  type: string
                  nullable: true
                anoLetivo:
                  type: integer
                periodo:
                  type: string
                  nullable: true
      responses:
        '201':
          description: Turma criada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Turma'
        '400':
          description: Dados inválidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Sem permissão
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Código já existe
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /turmas/{id}:
    get:
      tags:
        - Turmas
      summary: Obter turma por ID
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Dados da turma
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Turma'
        '404':
          description: Turma não encontrada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      tags:
        - Turmas
      summary: Atualizar turma
      description: Apenas ADMIN e COORDENADOR podem atualizar turmas
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                nome:
                  type: string
                  minLength: 3
                periodo:
                  type: string
                ativo:
                  type: boolean
      responses:
        '200':
          description: Turma atualizada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Turma'
        '403':
          description: Sem permissão
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Turma não encontrada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      tags:
        - Turmas
      summary: Deletar turma
      description: Apenas ADMIN pode deletar turmas
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Turma deletada
        '403':
          description: Sem permissão
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Turma não encontrada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /turmas/{id}/alunos:
    post:
      tags:
        - Vínculos
      summary: Matricular aluno na turma
      description: ADMIN e COORDENADOR podem matricular alunos
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - idAluno
              properties:
                idAluno:
                  type: string
                  format: uuid
      responses:
        '201':
          description: Aluno matriculado
        '409':
          description: Aluno já matriculado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /turmas/{id}/professores:
    post:
      tags:
        - Vínculos
      summary: Vincular professor à turma
      description: ADMIN e COORDENADOR podem vincular professores
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - idProfessor
              properties:
                idProfessor:
                  type: string
                  format: uuid
                papel:
                  type: string
                  default: RESPONSAVEL
      responses:
        '201':
          description: Professor vinculado
        '409':
          description: Professor já vinculado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /turmas/{idTurma}/aulas:
    get:
      tags:
        - Aulas
      summary: Listar aulas da turma
      security:
        - bearerAuth: []
      parameters:
        - name: idTurma
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: de
          in: query
          schema:
            type: string
            format: date-time
          description: Data inicial (filtro)
        - name: ate
          in: query
          schema:
            type: string
            format: date-time
          description: Data final (filtro)
      responses:
        '200':
          description: Lista de aulas
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Aula'

    post:
      tags:
        - Aulas
      summary: Criar aula
      description: ADMIN ou PROFESSOR vinculado à turma podem criar aulas
      security:
        - bearerAuth: []
      parameters:
        - name: idTurma
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - dataAula
              properties:
                titulo:
                  type: string
                  minLength: 3
                  nullable: true
                conteudo:
                  type: string
                  nullable: true
                dataAula:
                  type: string
                  format: date-time
                horaInicio:
                  type: string
                  format: date-time
                  nullable: true
                horaFim:
                  type: string
                  format: date-time
                  nullable: true
      responses:
        '201':
          description: Aula criada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Aula'
        '403':
          description: Professor não vinculado à turma
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /aulas/{id}:
    get:
      tags:
        - Aulas
      summary: Obter aula por ID
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Dados da aula
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Aula'
        '404':
          description: Aula não encontrada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      tags:
        - Aulas
      summary: Atualizar aula
      description: ADMIN ou PROFESSOR vinculado pode atualizar
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                titulo:
                  type: string
                conteudo:
                  type: string
                dataAula:
                  type: string
                  format: date-time
                horaInicio:
                  type: string
                  format: date-time
                horaFim:
                  type: string
                  format: date-time
      responses:
        '200':
          description: Aula atualizada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Aula'

    delete:
      tags:
        - Aulas
      summary: Deletar aula
      description: ADMIN ou PROFESSOR vinculado pode deletar
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Aula deletada

  /aulas/{id}/presencas:
    get:
      tags:
        - Presenças
      summary: Listar presenças da aula
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Lista de presenças
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Presenca'

    post:
      tags:
        - Presenças
      summary: Marcar presenças (lote)
      description: ADMIN ou PROFESSOR podem marcar presenças
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - presencas
              properties:
                presencas:
                  type: array
                  items:
                    type: object
                    required:
                      - idAluno
                      - status
                    properties:
                      idAluno:
                        type: string
                        format: uuid
                      status:
                        type: string
                        enum: [PRESENTE, AUSENTE, ATRASO, JUSTIFICADA]
                      observacao:
                        type: string
                        nullable: true
      responses:
        '201':
          description: Presenças marcadas
        '400':
          description: Aluno não matriculado na turma
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /turmas/{id}/presencas/relatorio:
    get:
      tags:
        - Relatórios
      summary: Relatório de presença da turma
      description: ADMIN, COORDENADOR ou PROFESSOR vinculado podem consultar
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: de
          in: query
          schema:
            type: string
            format: date-time
          description: Data inicial (filtro)
        - name: ate
          in: query
          schema:
            type: string
            format: date-time
          description: Data final (filtro)
      responses:
        '200':
          description: Relatório de presença
          content:
            application/json:
              schema:
                type: object
                properties:
                  turma:
                    $ref: '#/components/schemas/Turma'
                  totalAulas:
                    type: integer
                  alunos:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          format: uuid
                        nome:
                          type: string
                        totalPresente:
                          type: integer
                        totalAusente:
                          type: integer
                        totalAtraso:
                          type: integer
                        totalJustificada:
                          type: integer
                        percentualPresenca:
                          type: number
                          format: float
                        percentualAusencia:
                          type: number
                          format: float
        '403':
          description: Professor não vinculado à turma
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
